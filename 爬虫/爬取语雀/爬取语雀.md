# 基于语雀 API 的文档管理探索

## API 操作与说明

### 通用参数说明

```
https://www.yuque.com/yuque/developer/api
```

![](%E7%88%AC%E5%8F%96%E8%AF%AD%E9%9B%80.assets/image-20231115154629424.png)

**参数说明**

| Name      | Description                                                  | Example                                                    |
| --------- | ------------------------------------------------------------ | ---------------------------------------------------------- |
| id        | 数据的唯一编号/主键                                          | 1984                                                       |
| login     | 用户／团队的唯一名称 用户／团队编号                          | 用户：用户个人路径<br> 团队：如[语雀团队，login 值为 yuque |
| book_slug | 仓库唯一名称                                                 | 如语雀开发者文档这个仓库，book_slug 值为 developer         |
| namespace | 仓库的唯一名称 需要组合 :login/:book_slug 或可以直接使用仓库编号 | 如当前这篇文档的namespace是yuque/developer                 |
| slug      | 文档唯一名称                                                 | 如当前这篇文档的 slug 值为   api                           |

**返回数据格式**——JSON 格式

```json
{
  "data": {
    "id": 10,
    "slug": "weekly",
    "name": "技术周刊",
    "abilities": {
      "update": false,
      "destroy": false
    }
  },
  "meta": {
    "liked": false,
    "followed": false,
  }
}
```

### 使用api需要个人用户认证

获取 Token 可通过点击语雀的个人头像，并进入 [个人设置](https://www.yuque.com/settings/tokens) 页面拿到，如下图：

![image.png](%E7%88%AC%E5%8F%96%E8%AF%AD%E9%9B%80.assets/1680345283904-509c590e-b0b3-45a6-a9ff-aedde629b0c9.png)

### 获取个人的所有知识库

```python
import requests
headers = {
	"Content-Type": "application/json",
	"User-Agent": "YQExportMD",
	"X-Auth-Token": 'XJ..........PQCoJtjrIO'   //
}	
response = requests.request(method='GET', url='https://www.yuque.com/api/v2/users/shenweiyan/repos', headers=headers)
response.json()
```

```json
Out[16]:
{'data': [{'id': 227777,
   'type': 'Book',
   'slug': 'cookbook',
   'name': '技术私房菜',
   'user_id': 126032,
   'description': '原创技术文章，记录工作，学习的知识汇总。',
   'creator_id': 126032,
   'public': 1,
   'items_count': 218,
   'likes_count': 0,
   'watches_count': 182,
   'content_updated_at': '2022-12-02T07:27:32.714Z',
   'updated_at': '2022-12-02T07:27:33.000Z',
   'created_at': '2019-03-01T12:22:24.000Z',
   'namespace': 'shenweiyan/cookbook',
   'user': {'id': 126032,
    'type': 'User',
    'login': 'shenweiyan',
    'name': '章鱼猫先生',
    'description': '乐于分享，爱好码字，沉迷于折腾  | Bio & IT 爱好者',
    'avatar_url': 'https://cdn.yuque.com/yuque/0/2018/jpeg/126032/1526460304504-avatar/f6903e58-a5ec-4c79-9d61-f8c8e0e3f83c.jpeg',
    'followers_count': 765,
    'following_count': 95,
    'created_at': '2018-05-16T08:29:24.000Z',
    'updated_at': '2022-12-02T07:44:57.000Z',
    '_serializer': 'v2.user'},
   '_serializer': 'v2.book'},
  {'id': 174556,
   'type': 'Book',
   'slug': 'own',
   'name': '杂文私房菜',
   .....
  },
  ......
}		  
```

### 获取某个知识库内所有文档

知识库分为文档／画板两种类型。

```python
url  = "https://www.yuque.com/api/v2/repos/227777/docs"  # 227777 为对应知识库的 repo_id
resp = requests.request("GET", url, headers=headers)
repo_docs = resp.json()		# 得到一个以 data 为 key 的字典
docs = repo_docs['data']	# 返回一个包含该知识库所有文档的 list
```

```json
In [20]: docs[0].keys()     # 每个 list 是一个包含了 27 个 key 的字典
Out[20]: dict_keys(['id', 'slug', 'title', 'description', 'user_id', 'book_id', 'format', 'public', 'status', 'view_status', 'read_status', 'likes_count', 'read_count', 'comments_count', 'content_updated_at', 'created_at', 'updated_at', 'published_at', 'first_published_at', 'draft_version', 'last_editor_id', 'word_count', 'cover', 'custom_description', 'last_editor', 'book', '_serializer'])
```

### 获取某个指定文档的内容

#### 基于 API 1

最终的`doc['data']['body']`即为对应文章正文内容。

```python
repo_id, slug = "227777", "webstack-hugo"
url = "https://www.yuque.com/api/v2/repos/%s/docs/%s" % (repo_id, slug)
res = requests.request("GET", url, headers=headers)
doc = res.json() 	# 返回一个包含 ['abilities', 'data'] key 的字典
```

```json
In [30]: doc.keys()
Out[30]: dict_keys( ['abilities', 'data'] 

In [31]: doc['data'].keys()
Out[31]: dict_keys(['id', 'slug', 'title', 'book_id', 'book', 'user_id', 'creator', 'format', 'body', 'body_draft', 'body_html', 'body_lake', 'body_draft_lake', 'public', 'status', 'view_status', 'read_status', 'likes_count', 'comments_count', 'content_updated_at', 'deleted_at', 'created_at', 'updated_at', 'published_at', 'first_published_at', 'word_count', 'cover', 'description', 'custom_description', 'hits', '_serializer'])				   
In [26]: doc
Out[26]:
{'abilities': {'update': True, 'destroy': True},
 'data': {'id': 49148406,
  'slug': 'webstack-hugo',
  'title': 'WebStack-Hugo | 一个静态响应式网址导航主题',
  'book_id': 227777,
  'book': {'id': 227777,
   'type': 'Book',
   'slug': 'cookbook',
   'name': '技术私房菜',
   'user_id': 126032,
   'description': '原创技术文章，记录工作，学习的知识汇总。',
   'creator_id': 126032,
   'public': 1,
   'items_count': 218,
   'likes_count': 0,
   'watches_count': 182,
   'content_updated_at': '2022-12-02T07:27:32.714Z',
   'updated_at': '2022-12-02T07:27:33.000Z',
   'created_at': '2019-03-01T12:22:24.000Z',
   'namespace': 'shenweiyan/cookbook',
   'user': {'id': 126032,
    'type': 'User',
    'login': 'shenweiyan',
    'name': '章鱼猫先生',
    'description': '乐于分享，爱好码字，沉迷于折腾  | Bio & IT 爱好者',
    'avatar_url': 'https://cdn.yuque.com/yuque/0/2018/jpeg/126032/1526460304504-avatar/f6903e58-a5ec-4c79-9d61-f8c8e0e3f83c.jpeg',
    'books_count': 27,
    'public_books_count': 12,
    'followers_count': 765,
    'following_count': 95,
    'created_at': '2018-05-16T08:29:24.000Z',
    'updated_at': '2022-12-02T07:44:57.000Z',
    '_serializer': 'v2.user'},
   '_serializer': 'v2.book'},
  'user_id': 126032,
  'creator': {'id': 126032,
   'type': 'User',
   'login': 'shenweiyan',
   'name': '章鱼猫先生',
   'description': '乐于分享，爱好码字，沉迷于折腾  | Bio & IT 爱好者',
   'avatar_url': 'https://cdn.yuque.com/yuque/0/2018/jpeg/126032/1526460304504-avatar/f6903e58-a5ec-4c79-9d61-f8c8e0e3f83c.jpeg',
   'books_count': 27,
   'public_books_count': 12,
   'followers_count': 765,
   'following_count': 95,
   'created_at': '2018-05-16T08:29:24.000Z',
   'updated_at': '2022-12-02T07:44:57.000Z',
   '_serializer': 'v2.user'},
  'format': 'lake',
  'body': ':::tips\n**📢 如果您参考本主题构建了属于你自己的网址导航，欢迎在评论区留下你网站的访问链接。**\n:::\......
   .....
  
```

#### 基于 API 2

![image-20231115163517002](%E7%88%AC%E5%8F%96%E8%AF%AD%E9%9B%80.assets/image-20231115163517002.png)

**api:** 

```
https://www.yuque.com/api/docs/' + sulg + '?book_id=' + book_id + '&merge_dynamic_data=false&mode=markdown'
```

![image-20231115163537255](%E7%88%AC%E5%8F%96%E8%AF%AD%E9%9B%80.assets/image-20231115163537255.png)

**测试**

![image-20231115163630501](%E7%88%AC%E5%8F%96%E8%AF%AD%E9%9B%80.assets/image-20231115163630501.png)



#### 不用 API

如果语雀某一篇公开文档的链接，如 https://www.yuque.com/yuque/developer/api，我们可以在该 url 后增加 **"/markdown?plain=true&linebreak=false&anchor=false"**，即可在浏览器直接查阅该文档的 markdown 格式内容。

```
https://www.yuque.com/yuque/developer/api/markdown?plain=true&linebreak=false&anchor=false
```

[https://www.yuque.com/yuque/developer/api/markdown?plain=true&linebreak=false&anchor=false](https://www.yuque.com/yuque/developer/api/markdown?plain=true&linebreak=false&anchor=false)

[![image.png](%E7%88%AC%E5%8F%96%E8%AF%AD%E9%9B%80.assets/1669971411350-a3ecd66d-c480-4f12-aaba-1c63ac20e998.png)](https://cos.shenlab.cn/yuque/0/2022/png/126032/1669971411350-a3ecd66d-c480-4f12-aaba-1c63ac20e998.png)

接下来的操作就很简单了，我们可以直接复制该 markdown 内容，或者用程序直接抓取下来。

```python
In [46]: res = requests.request("GET", 'https://www.yuque.com/yuque/developer/api/markdown?plain=true&linebreak=false&anchor=false', headers=headers)

In [47]: res.text
Out[47]: '## 基本路径\n\n所有 API 的路径都以 `https://www.yuque.com/api/v2` 开头。\n空间下访问 API 的域名需要使用空间对应的域名，例如空间域名为 customspace.yuque.com， 则 API 的基础路径为 `https://customspace.yuque.com/api/v2`。\n\n建议开启 follow redirect 能力:\n```bash\n# -L To follow redirect with Curl\ncurl -L -X "POST" "https://www.yuque.com/api/v2/..." \\\n     -H \'User-Agent: your_name\' \\\n     -H \'X-Auth-Token: your_token\' \\\n     -H \'Content-Type: application/json\' \\\n     -d $\'{}\'\n```\n\n## HTTP Verbs\n\n| Verb | Description |\n| --- | --- |\n| GET | 用于获取数据 |\n| POST | 用于创建数据 |\n| PUT | 用于修改部分数据，例如一个文档标题，正文 |\n| DELETE | 用于删除数据 |\n\n\n## HTTP 提交数据说明\n\n当\xa0**POST**,\xa0**PUT**\xa0请求的时候，请确保 Request Content-Type 是 `application/json`\xa0类型。\n\n```json\nreq.Headers.Add("Content-Type", "application/json")\n```\n\n\n## User-Agent Header\n\n为了确保我们能知道访问者是谁，API 要求必须传递 `User-Agent` Header，否则将会拒绝请求。\n\n例如:\n```go\nreq.Headers.Add("User-Agent", "这里可以填应用名称")\n```\n\n## 用户认证\n\n:::info\n语雀所有的开放 API 都需要 Token 验证之后才能访问。\n:::\n\n语雀 API 目前使用 Token 机制来实现用户认证。\n\n你需要在请求的 HTTP Headers 传入 `X-Auth-Token` 带入用户的 Token 信息，用于认证。\n\n获取 Token 可通过点击语雀的个人头像，并进入\xa0[个人设置](/settings/tokens)\xa0页面拿到，如下图：\n![image.png](https://cos.shenlab.cn/yuque/0/2019/png/84145/1556263208113-272c18c0-2608-48b5-81b0-141b49ef432f.png)\xa0标准格式，请按照标准方式进行转换。\n'

In [48]:
```

### 语雀图片备份处理

语雀的图片可以直接下载到本地（参考：https://github.com/shenweiyan/YQExportMD），或者使用镜像回源的方式直接转存到阿里云/腾讯云…..的对象存储中（参考：[语雀图片的同步迁移解决方案](https://www.yuque.com/shenweiyan/cookbook/sync-from-yuque-to-oss?view=doc_embed)），这里暂时不展开。

# 正式爬虫——网页分析

## 分析网站

```
https://www.yuque.com/aceld/mo95lb/dsk886
```

![image-20231115150729673](%E7%88%AC%E5%8F%96%E8%AF%AD%E9%9B%80.assets/image-20231115150729673.png)

把上述数据进行json解析

```json
{
    "me": {
        "avatar_url": "https://gw.alipayobjects.com/zos/rmsportal/ApEnVmpRbThmwJJukDlb.jpeg",
        "avatar": "https://gw.alipayobjects.com/zos/rmsportal/ApEnVmpRbThmwJJukDlb.jpeg",
        "language": "zh-cn",
        "is_admin": false,
        "is_uirobot": false
    },
    "notification": {},
    "settings": {
        "allowed_link_schema": [
            "dingtalk:"
        ],
        "enable_link_interception": true,
        "enable_new_user_public_ability_forbid": true,
        "user_registry_forbidden_level": "",
        "watermark_enable": "",
        "public_space_doc_search_enable": true,
        "lake_enabled_groups": "*",
        "image_proxy_root": "",
        "max_import_task_count": 1,
        "enable_search": true,
        "enable_serviceworker": true,
        "enable_lazyload_card": "codeblock",
        "editor_canary": {
            "card_lazy_init": 100,
            "retryOriginImage": 100
        },
        "enable_attachment_multipart": true,
        "enable_custom_video_player": true,
        "conference_gift_num": 0,
        "intranet_safe_tip": [
            "open"
        ],
        "publication_enable_whitelist": [],
        "foreign_phone_registry_enabled_organization_whitelist": [
            "16014876",
            "16022684",
            "16052442",
            "18041640",
            "1437",
            "1565",
            "1796",
            "2838",
            "16052442",
            "309",
            "22614",
            "1780",
            "6001397",
            "14481",
            "14040138",
            "16052442",
            "14043106",
            "14006688",
            "16033469",
            "18044074",
            "11321",
            "2008",
            "35721",
            "6001216",
            "806",
            "18041640",
            "18100055",
            "16014876",
            "16022684",
            "20013926"
        ],
        "disabled_login_modal_pop_default": true,
        "enable_open_in_mobile_app": true,
        "enable_wechat_guide_qrcode": true,
        "enable_issue": true,
        "enable_blank_page_detect": true,
        "zone_ant_auth_keepalive_enabled_domains": [],
        "enable_new_group_page_whitelist": [],
        "enable_web_ocr": {
            "enable": true,
            "enableBrowsers": [
                "chrome"
            ],
            "_users": [
                106822
            ],
            "percent": 100
        },
        "customer_staff_dingtalk_id": "",
        "enable_desktop_force_local": true,
        "side_third_app_config": {},
        "desktop_check_network_status_interval": 30,
        "review_assistant_provider_url": "",
        "debug_assistant_provider_url": "",
        "codefuse_assistant_provider_url": "",
        "user_certifications_share_whitelist": [
            "352135",
            "39191355",
            "95294",
            "13012852",
            "39187844",
            "39195365",
            "22303185",
            "39199571",
            "39200198"
        ],
        "user_certifications_share_scale": 10,
        "support_extension_download_url": true,
        "user_communication_group_qrcode": "https://mdn.alipayobjects.com/huamei_0prmtq/afts/img/A*5CiSRraBRL0AAAAAAAAAAAAADvuFAQ/original"
    },
    "env": "prod",
    "space": {
        "id": 0,
        "login": "",
        "name": "语雀",
        "short_name": null,
        "status": 0,
        "account_id": 0,
        "logo": null,
        "description": "",
        "created_at": null,
        "updated_at": null,
        "host": "https://www.yuque.com",
        "displayName": "语雀",
        "logo_url": "https://cdn.nlark.com/yuque/0/2022/png/303152/1665994257081-avatar/dcb74862-1409-4691-b9ce-8173b4f6e037.png",
        "enable_password": true,
        "enable_watermark": false,
        "_serializer": "web.space"
    },
    "isYuque": true,
    "isPublicCloud": true,
    "isEnterprise": false,
    "isUseAntLogin": false,
    "defaultSpaceHost": "https://www.yuque.com",
    "timestamp": 1700027795009,
    "traceId": "ac136c6317000277948812181129",
    "siteName": "语雀",
    "siteTip": null,
    "activityTip": null,
    "topTip": null,
    "readTip": {},
    "questionRecommend": null,
    "dashboardBannerRecommend": null,
    "imageServiceDomains": [
        "cdn.yuque.com",
        "cdn.nlark.com",
        "img.shields.io",
        "travis-ci.org",
        "api.travis-ci.org",
        "npm.packagequality.com",
        "snyk.io",
        "coveralls.io",
        "badgen.now.sh",
        "badgen.net",
        "packagephobia.now.sh",
        "duing.alibaba-inc.com",
        "npm.alibaba-inc.com",
        "web.npm.alibaba-inc.com",
        "npmjs.com",
        "npmjs.org",
        "npg.dockerlab.alipay.net",
        "private-alipayobjects.alipay.com",
        "googleusercontent.com",
        "blogspot.com",
        "cdn.hk01.com",
        "camo.githubusercontent.com",
        "gw.daily.taobaocdn.net",
        "cdn-images-1.medium.com",
        "medium.com",
        "i.stack.imgur.com",
        "imgur.com",
        "doc.ucweb.local",
        "lh6.googleusercontent.com",
        "4.bp.blogspot.com",
        "bp.blogspot.com",
        "blogspot.com",
        "1.bp.blogspot.com",
        "2.bp.blogspot.com",
        "3.bp.blogspot.com",
        "aliwork-files.oss-accelerate.aliyuncs.com",
        "oss-accelerate.aliyuncs.com",
        "work.alibaba.net",
        "work.alibaba-inc.com",
        "work-file.alibaba.net",
        "work-file.alibaba-inc.com",
        "pre-work-file.alibaba-inc.com",
        "yuque.antfin.com",
        "yuque.antfin-inc.com",
        "intranetproxy.alipay.com",
        "lark-assets-prod-aliyun.oss-accelerate.aliyuncs.com",
        "lh1.googleusercontent.com",
        "lh2.googleusercontent.com",
        "lh3.googleusercontent.com",
        "lh4.googleusercontent.com",
        "lh5.googleusercontent.com",
        "lh6.googleusercontent.com",
        "lh7.googleusercontent.com",
        "lh8.googleusercontent.com",
        "lh9.googleusercontent.com",
        "raw.githubusercontent.com",
        "github.com",
        "en.wikipedia.org",
        "rawcdn.githack.com",
        "pre-work-file.alibaba-inc.com",
        "alipay-rmsdeploy-image.cn-hangzhou.alipay.aliyun-inc.com",
        "antsys-align-files-management.cn-hangzhou.alipay.aliyun-inc.com",
        "baiyan-pre.antfin.com",
        "baiyan.antfin.com",
        "baiyan.dev.alipay.net",
        "marketing.aliyun-inc.com",
        "lark-temp.oss-cn-hangzhou.aliyuncs.com",
        "www.yuque.com",
        "yuque.com",
        "cdn.nlark.com"
    ],
    "sharePlatforms": [
        "wechat",
        "dingtalk"
    ],
    "locale": "zh-cn",
    "matchCondition": {
        "fileType": "Doc",
        "useTileRendering": true,
        "useEditorTileRendering": true,
        "useEditorTileRenderingForOT": true,
        "useEditorVirtualRenderingForOT": false,
        "useEditorDelayTileChange": true,
        "useEditorVirtualRendering": false
    },
    "empInfo": {},
    "enableSideThirdApp": false,
    "customTracertConfig": {
        "spmBPos": "doc_read"
    },
    "group": {
        "id": 26269664,
        "type": "User",
        "login": "aceld",
        "name": "刘丹冰Aceld",
        "description": "https://github.com/aceld",
        "avatar": "https://cdn.nlark.com/yuque/0/2022/png/26269664/1651594557072-avatar/c20a2fdd-3126-4dea-b477-0866022d648a.png",
        "avatar_url": "https://cdn.nlark.com/yuque/0/2022/png/26269664/1651594557072-avatar/c20a2fdd-3126-4dea-b477-0866022d648a.png",
        "owner_id": null,
        "books_count": 15,
        "public_books_count": 11,
        "topics_count": 0,
        "public_topics_count": 0,
        "members_count": 0,
        "abilities": {
            "create_book": false,
            "create_member": false,
            "destroy": false,
            "read": true,
            "read_private": false,
            "update": false,
            "manage": false,
            "restore": false,
            "read_tag": false
        },
        "settings": null,
        "public": 1,
        "extend_private": 0,
        "scene": null,
        "created_at": "2022-02-24T03:52:25.000Z",
        "updated_at": "2023-11-14T13:42:46.000Z",
        "expired_at": "2024-09-24T15:59:59.000Z",
        "deleted_at": null,
        "organization_id": 0,
        "isPaid": true,
        "member_level": 1,
        "memberLevelName": "专业会员",
        "hasMemberLevel": true,
        "isTopLevel": false,
        "grains_sum": 15340,
        "status": 1,
        "source": "index",
        "zone_id": 0,
        "isPermanentPunished": false,
        "isWiki": false,
        "isPublicPage": false,
        "organization": null,
        "owners": null,
        "_serializer": "web.group"
    },
    "book": {
        "id": 26950668,
        "type": "Book",
        "slug": "mo95lb",
        "name": "8小时转职Golang工程师",
        "toc": [
            {
                "type": "DOC",
                "title": "8小时转职Golang工程师",
                "uuid": "GZZu-Lrlbv0Ig3tk",
                "url": "dsk886",
                "prev_uuid": "",
                "sibling_uuid": "rBPgqqPG8K-9cjcw",
                "child_uuid": "",
                "parent_uuid": "",
                "doc_id": 74372830,
                "level": 0,
                "id": 74372830,
                "open_window": 1,
                "visible": 1
            },
            {
                "type": "DOC",
                "title": "一、引言",
                "uuid": "rBPgqqPG8K-9cjcw",
                "url": "zwukev",
                "prev_uuid": "GZZu-Lrlbv0Ig3tk",
                "sibling_uuid": "xp3xOn_vIq2YocE3",
                "child_uuid": "",
                "parent_uuid": "",
                "doc_id": 74374885,
                "level": 0,
                "id": 74374885,
                "open_window": 1,
                "visible": 1
            },
            {
                "type": "DOC",
                "title": "二、Golang开发环境",
                "uuid": "xp3xOn_vIq2YocE3",
                "url": "haizwm",
                "prev_uuid": "rBPgqqPG8K-9cjcw",
                "sibling_uuid": "eCDGTOv8KvDNEUP8",
                "child_uuid": "",
                "parent_uuid": "",
                "doc_id": 74377607,
                "level": 0,
                "id": 74377607,
                "open_window": 1,
                "visible": 1
            },
            {
                "type": "DOC",
                "title": "三、Golang语言特性",
                "uuid": "eCDGTOv8KvDNEUP8",
                "url": "xk0fqo",
                "prev_uuid": "xp3xOn_vIq2YocE3",
                "sibling_uuid": "SZxxnlq-DGqt6ojH",
                "child_uuid": "",
                "parent_uuid": "",
                "doc_id": 74378532,
                "level": 0,
                "id": 74378532,
                "open_window": 1,
                "visible": 1
            },
            {
                "type": "DOC",
                "title": "四、Golang语法新奇",
                "uuid": "SZxxnlq-DGqt6ojH",
                "url": "ye2kii",
                "prev_uuid": "eCDGTOv8KvDNEUP8",
                "sibling_uuid": "L8l44hSlXdJh_N9Y",
                "child_uuid": "ELFbbcnHwqayR3mB",
                "parent_uuid": "",
                "doc_id": 74379206,
                "level": 0,
                "id": 74379206,
                "open_window": 1,
                "visible": 1
            },
            {
                "type": "DOC",
                "title": "1、从一个main函数初见golang语法",
                "uuid": "ELFbbcnHwqayR3mB",
                "url": "pz6nag",
                "prev_uuid": "SZxxnlq-DGqt6ojH",
                "sibling_uuid": "FCiomMp3QXm0T4rI",
                "child_uuid": "",
                "parent_uuid": "SZxxnlq-DGqt6ojH",
                "doc_id": 74379267,
                "level": 1,
                "id": 74379267,
                "open_window": 1,
                "visible": 1
            },
            {
                "type": "DOC",
                "title": "2、变量的声明",
                "uuid": "FCiomMp3QXm0T4rI",
                "url": "mayg6h",
                "prev_uuid": "ELFbbcnHwqayR3mB",
                "sibling_uuid": "ttrS5CUQ0kILJPUH",
                "child_uuid": "",
                "parent_uuid": "SZxxnlq-DGqt6ojH",
                "doc_id": 74465041,
                "level": 1,
                "id": 74465041,
                "open_window": 1,
                "visible": 1
            },
            {
                "type": "DOC",
                "title": "3、常量",
                "uuid": "ttrS5CUQ0kILJPUH",
                "url": "acsgdr",
                "prev_uuid": "FCiomMp3QXm0T4rI",
                "sibling_uuid": "j7QRBe2kuUJUZjEI",
                "child_uuid": "",
                "parent_uuid": "SZxxnlq-DGqt6ojH",
                "doc_id": 74465186,
                "level": 1,
                "id": 74465186,
                "open_window": 1,
                "visible": 1
            },
            {
                "type": "DOC",
                "title": "4、函数",
                "uuid": "j7QRBe2kuUJUZjEI",
                "url": "kk9cvo",
                "prev_uuid": "ttrS5CUQ0kILJPUH",
                "sibling_uuid": "a9A1C01ErDjuybHU",
                "child_uuid": "",
                "parent_uuid": "SZxxnlq-DGqt6ojH",
                "doc_id": 74465350,
                "level": 1,
                "id": 74465350,
                "open_window": 1,
                "visible": 1
            },
            {
                "type": "DOC",
                "title": "5、defer",
                "uuid": "a9A1C01ErDjuybHU",
                "url": "zz7w9r",
                "prev_uuid": "j7QRBe2kuUJUZjEI",
                "sibling_uuid": "6PzhCBcD76hl3zew",
                "child_uuid": "",
                "parent_uuid": "SZxxnlq-DGqt6ojH",
                "doc_id": 74466057,
                "level": 1,
                "id": 74466057,
                "open_window": 1,
                "visible": 1
            },
            {
                "type": "DOC",
                "title": "6、slice和map",
                "uuid": "6PzhCBcD76hl3zew",
                "url": "ovmzgh",
                "prev_uuid": "a9A1C01ErDjuybHU",
                "sibling_uuid": "fOry1ZHGnKd6aTz4",
                "child_uuid": "",
                "parent_uuid": "SZxxnlq-DGqt6ojH",
                "doc_id": 74466087,
                "level": 1,
                "id": 74466087,
                "open_window": 1,
                "visible": 1
            },
            {
                "type": "DOC",
                "title": "7、面向对象特征",
                "uuid": "fOry1ZHGnKd6aTz4",
                "url": "aoxo9v",
                "prev_uuid": "6PzhCBcD76hl3zew",
                "sibling_uuid": "ZxREAqbz152Iz6_X",
                "child_uuid": "",
                "parent_uuid": "SZxxnlq-DGqt6ojH",
                "doc_id": 74466563,
                "level": 1,
                "id": 74466563,
                "open_window": 1,
                "visible": 1
            },
            {
                "type": "DOC",
                "title": "8、interface与类型断言",
                "uuid": "ZxREAqbz152Iz6_X",
                "url": "frv2c9",
                "prev_uuid": "fOry1ZHGnKd6aTz4",
                "sibling_uuid": "lGAqtBM1qMNydg8X",
                "child_uuid": "",
                "parent_uuid": "SZxxnlq-DGqt6ojH",
                "doc_id": 74466779,
                "level": 1,
                "id": 74466779,
                "open_window": 1,
                "visible": 1
            },
            {
                "type": "DOC",
                "title": "9、反射reflect",
                "uuid": "lGAqtBM1qMNydg8X",
                "url": "cwur9v",
                "prev_uuid": "ZxREAqbz152Iz6_X",
                "sibling_uuid": "9eIEgt0rAWk5qR7d",
                "child_uuid": "",
                "parent_uuid": "SZxxnlq-DGqt6ojH",
                "doc_id": 74468558,
                "level": 1,
                "id": 74468558,
                "open_window": 1,
                "visible": 1
            },
            {
                "type": "DOC",
                "title": "10、结构体标签",
                "uuid": "9eIEgt0rAWk5qR7d",
                "url": "ybul6x",
                "prev_uuid": "lGAqtBM1qMNydg8X",
                "sibling_uuid": "",
                "child_uuid": "",
                "parent_uuid": "SZxxnlq-DGqt6ojH",
                "doc_id": 74591927,
                "level": 1,
                "id": 74591927,
                "open_window": 1,
                "visible": 1
            },
            {
                "type": "DOC",
                "title": "五、Golang高阶",
                "uuid": "L8l44hSlXdJh_N9Y",
                "url": "br98sg",
                "prev_uuid": "SZxxnlq-DGqt6ojH",
                "sibling_uuid": "vaeP1oQNZ1GK87NA",
                "child_uuid": "K-6lEis-5-X7fqNx",
                "parent_uuid": "",
                "doc_id": 74592160,
                "level": 0,
                "id": 74592160,
                "open_window": 1,
                "visible": 1
            },
            {
                "type": "DOC",
                "title": "4、Go Modules",
                "uuid": "K-6lEis-5-X7fqNx",
                "url": "ovib08",
                "prev_uuid": "L8l44hSlXdJh_N9Y",
                "sibling_uuid": "11ifpgM3MHZR3J6Y",
                "child_uuid": "",
                "parent_uuid": "L8l44hSlXdJh_N9Y",
                "doc_id": 74594438,
                "level": 1,
                "id": 74594438,
                "open_window": 1,
                "visible": 1
            },
            {
                "type": "DOC",
                "title": "1、goroutine",
                "uuid": "11ifpgM3MHZR3J6Y",
                "url": "vlnvyb",
                "prev_uuid": "K-6lEis-5-X7fqNx",
                "sibling_uuid": "q7Hc4JQmjrzU0Rqm",
                "child_uuid": "",
                "parent_uuid": "L8l44hSlXdJh_N9Y",
                "doc_id": 74592256,
                "level": 1,
                "id": 74592256,
                "open_window": 1,
                "visible": 1
            },
            {
                "type": "DOC",
                "title": "2、channel",
                "uuid": "q7Hc4JQmjrzU0Rqm",
                "url": "ir4ckz",
                "prev_uuid": "11ifpgM3MHZR3J6Y",
                "sibling_uuid": "0RSxuW0JgVWGAOAi",
                "child_uuid": "",
                "parent_uuid": "L8l44hSlXdJh_N9Y",
                "doc_id": 74592638,
                "level": 1,
                "id": 74592638,
                "open_window": 1,
                "visible": 1
            },
            {
                "type": "DOC",
                "title": "3、Select",
                "uuid": "0RSxuW0JgVWGAOAi",
                "url": "irl276",
                "prev_uuid": "q7Hc4JQmjrzU0Rqm",
                "sibling_uuid": "",
                "child_uuid": "",
                "parent_uuid": "L8l44hSlXdJh_N9Y",
                "doc_id": 74593989,
                "level": 1,
                "id": 74593989,
                "open_window": 1,
                "visible": 1
            },
            {
                "type": "DOC",
                "title": "六、案例-即时通信系统",
                "uuid": "vaeP1oQNZ1GK87NA",
                "url": "ks1lr9",
                "prev_uuid": "L8l44hSlXdJh_N9Y",
                "sibling_uuid": "",
                "child_uuid": "",
                "parent_uuid": "",
                "doc_id": 74594942,
                "level": 0,
                "id": 74594942,
                "open_window": 1,
                "visible": 1
            }
        ],
        "toc_updated_at": "2022-04-22T06:05:32.000Z",
        "description": "本书偏入门级，主要是针对后端想快速低成本掌握golang开发人群学习，如您已经掌握golang请绕行。",
        "creator_id": 26269664,
        "menu_type": 0,
        "items_count": 21,
        "likes_count": 0,
        "watches_count": 49,
        "user_id": 26269664,
        "abilities": {
            "create": false,
            "update": false,
            "destroy": false,
            "create_doc": false,
            "update_toc": false,
            "read": true,
            "read_private": false,
            "export": false,
            "export_doc": false,
            "manage": false,
            "join": true,
            "share": false,
            "modify_setting": false,
            "create_collaborator": false,
            "download": false
        },
        "public": 1,
        "extend_private": 0,
        "scene": null,
        "source": null,
        "created_at": "2022-04-20T14:58:19.000Z",
        "updated_at": "2023-08-24T15:00:48.000Z",
        "pinned_at": null,
        "archived_at": null,
        "layout": "Book",
        "doc_typography": "classic_all",
        "doc_viewport": "fixed",
        "announcement": null,
        "should_manually_create_uid": false,
        "catalog_tail_type": "UPDATED_AT",
        "catalog_display_level": 1,
        "book_icon": {
            "type": "url",
            "symbol": "group-type-department"
        },
        "cover": "https://cdn.nlark.com/assets/88660/png/cover_3.png",
        "comment_count": null,
        "organization_id": 0,
        "status": 0,
        "indexed_level": 1,
        "privacy_migrated": true,
        "collaboration_count": 1,
        "content_updated_at": "2023-08-24T15:00:47.836Z",
        "content_updated_at_ms": 1692889247836,
        "copyright_watermark": "",
        "enable_announcement": true,
        "enable_auto_publish": false,
        "enable_automation": false,
        "enable_comment": true,
        "enable_document_copy": true,
        "enable_export": true,
        "enable_search_engine": false,
        "enable_toc": true,
        "enable_trash": true,
        "enable_visitor_watermark": false,
        "enable_webhook": true,
        "image_copyright_watermark": "",
        "original": 0,
        "resource_size": 0,
        "user": null,
        "contributors": null,
        "_serializer": "web.book_detail"
    },
    "doc": {
        "id": 74466779,
        "space_id": 0,
        "type": "Doc",
        "sub_type": null,
        "title": "8、interface与类型断言",
        "tag": null,
        "slug": "frv2c9",
        "user_id": 26269664,
        "book_id": 26950668,
        "cover": null,
        "description": "Golang的语言中提供了断言的功能。golang中的所有程序都实现了interface{}的接口，这意味着，所有的类型如string,int,int64甚至是自定义的struct类型都就此拥有了interface{}的接口，这种做法和java中的Object类型比较类似。那么在一个数据通过f...",
        "custom_description": null,
        "body_asl": "",
        "format": "lake",
        "origin_format": "lake",
        "status": 1,
        "read_status": 1,
        "view_status": 0,
        "public": 1,
        "draft_version": 2,
        "comments_count": 0,
        "likes_count": 26,
        "abilities": {
            "destroy": false,
            "read": true,
            "update": false,
            "create_collaborator": false,
            "manage": false,
            "share": false
        },
        "content_updated_at": "2022-04-21T08:18:56.000Z",
        "created_at": "2022-04-21T08:18:31.000Z",
        "updated_at": "2023-09-05T16:12:14.000Z",
        "published_at": "2022-04-21T08:18:56.000Z",
        "first_published_at": "2022-04-21T08:18:56.182Z",
        "pinned_at": null,
        "word_count": 546,
        "selected_at": null,
        "editor_meta": "{\"codeblock\":8}",
        "editor_meta_draft": "{\"codeblock\":8}",
        "meta": {
            "privacy_migrated": true
        },
        "region": null,
        "indexed_level": 1,
        "privacy_migrated": true,
        "share_expired_time": null,
        "_serializer": "web.doc_detail"
    },
    "isDocCollaborator": false,
    "isCollaborationPage": false,
    "forbidLoginCard": false,
    "loginCardPV": 2000,
    "docUrl": "https://www.yuque.com/aceld/mo95lb/frv2c9",
    "search": {
        "display": true,
        "scope": "aceld/mo95lb"
    },
    "prefetch": "fetchReadDocData",
    "enableMobileAppRelease": false,
    "enableUserFeed": false,
    "groupMemberInfo": {
        "usage": {
            "attachment_size": 154978817,
            "image_size": 191931283,
            "video_size": 0,
            "attachment_size_month": 0,
            "image_size_month": 0,
            "video_size_month": 0,
            "max_upload_size": 10737418240,
            "_serializer": "web.user_usage_statistics"
        },
        "totalDocAndNoteUsageMonth": 0,
        "expired_at": "2024-09-24T15:59:59.000Z",
        "countDownDays": 314,
        "isAllowRenew": false,
        "receipt": null,
        "groupOwners": [],
        "hasOrder": true
    },
    "canUseAiWriting": false,
    "canUseAiLegal": false,
    "canUseAiReading": false,
    "aiWritingStreamType": [],
    "legalAnimationTime": 50,
    "canUseAiTestCase": false,
    "canUseAiOutline": false,
    "virtualRenderingGrey": false,
    "userSettings": {},
    "interest": {
        "interests": {
            "create_public_resource": true,
            "book_statistics": true,
            "book_security": true,
            "book_webhook": true,
            "open_ocr": true
        },
        "limits": {
            "0": {
                "max_resource_total_size": null,
                "max_resource_month_size": 1073741824,
                "max_book_number": 100,
                "max_doc_note_number": 100,
                "max_group_number": 10,
                "max_book_collaborator_number": 5,
                "max_doc_collaborator_number": 5,
                "max_single_file_size": 31457280,
                "max_single_image_size": 10485760,
                "max_single_video_size": 0
            },
            "1": {
                "max_resource_total_size": null,
                "max_resource_month_size": 10737418240,
                "max_book_number": null,
                "max_doc_note_number": null,
                "max_group_number": 10,
                "max_book_collaborator_number": 50,
                "max_doc_collaborator_number": 50,
                "max_single_file_size": 524288000,
                "max_single_image_size": 20971520,
                "max_single_video_size": 524288000
            },
            "2": {
                "max_resource_total_size": null,
                "max_resource_month_size": 53687091200,
                "max_book_number": null,
                "max_doc_note_number": null,
                "max_group_number": 10,
                "max_single_file_size": 2147483648,
                "max_single_image_size": 52428800,
                "max_single_video_size": 2147483648,
                "max_book_collaborator_number": 500,
                "max_doc_collaborator_number": 500
            }
        },
        "owner": {
            "id": 26269664,
            "type": "User",
            "member_level": 1,
            "isTopLevel": false,
            "isMemberTopLevel": false,
            "isPaid": true,
            "isExpired": false
        },
        "limit": {
            "max_resource_total_size": null,
            "max_resource_month_size": 10737418240,
            "max_book_number": null,
            "max_doc_note_number": null,
            "max_group_number": 10,
            "max_book_collaborator_number": 50,
            "max_doc_collaborator_number": 50,
            "max_single_file_size": 524288000,
            "max_single_image_size": 20971520,
            "max_single_video_size": 524288000
        }
    },
    "isRunAtRaw": false,
    "paymentInfo": {
        "paymentBizInstId": "Z69"
    },
    "login": {
        "loginType": "normal",
        "enablePlatforms": [
            "dingtalk",
            "alipay",
            "wechat",
            "teambition",
            "apple"
        ],
        "isWechatMobileApp": false
    },
    "enableCoverageDeploy": false,
    "isDesktopApp": false,
    "isOnlineDesktopApp": false,
    "isIsomorphicDesktopApp": false,
    "isAssistant": false,
    "isAlipayApp": false,
    "isDingTalkApp": false,
    "isDingTalkMiniApp": false,
    "isDingTalkDesktopApp": false,
    "isYuqueMobileApp": false,
    "tracertConfig": {
        "spmAPos": "a385",
        "spmBPos": "doc_read"
    }
}
```

### 格式化json数据

再把json数据在[JSON在线编辑器](https://www.sojson.com/editor.html)里格式化分析, 结果如下

![FISG89}2WHWZYMM2I55_C2J](%E7%88%AC%E5%8F%96%E8%AF%AD%E9%9B%80.assets/FISG89%7D2WHWZYMM2I55_C2J.png)详情

![image-20231115152637477](%E7%88%AC%E5%8F%96%E8%AF%AD%E9%9B%80.assets/image-20231115152637477.png)

发现book对象中toc数组存放的就是该知识库的所有文档的一些信息

### **结合待爬页面分析**

**sulg:**

![image-20231115152549332](%E7%88%AC%E5%8F%96%E8%AF%AD%E9%9B%80.assets/image-20231115152549332.png)

![image-20231115152445870](%E7%88%AC%E5%8F%96%E8%AF%AD%E9%9B%80.assets/image-20231115152445870.png)

**book_id:**

<img src="%E7%88%AC%E5%8F%96%E8%AF%AD%E9%9B%80.assets/image-20231115155718447.png" alt="image-20231115155718447" style="zoom:67%;" />

补充: (这个python代码中没使用)

 <img src="%E7%88%AC%E5%8F%96%E8%AF%AD%E9%9B%80.assets/image-20231115164526509.png" alt="image-20231115164526509" style="zoom:67%;" />

**使用语雀的API:**

```
'https://www.yuque.com/api/docs/' + sulg + '?book_id=' + book_id + '&merge_dynamic_data=false&mode=markdown')
```

测试

![image-20231115163841654](%E7%88%AC%E5%8F%96%E8%AF%AD%E9%9B%80.assets/image-20231115163841654.png)



**进一步分析**

绑定是文件夹还是md文件

情况一

![image-20231115203458723](%E7%88%AC%E5%8F%96%E8%AF%AD%E9%9B%80.assets/image-20231115203458723.png)

对应

<img src="%E7%88%AC%E5%8F%96%E8%AF%AD%E9%9B%80.assets/image-20231115203413416.png" style="zoom:150%;" />

情况二

<img src="%E7%88%AC%E5%8F%96%E8%AF%AD%E9%9B%80.assets/image-20231115210358143.png" alt="image-20231115210358143" style="zoom:80%;" />

情况三  多级文件夹

![image-20231115211539868](%E7%88%AC%E5%8F%96%E8%AF%AD%E9%9B%80.assets/image-20231115211539868.png)

## 编写python代码

思路:

+ 制作文章目录(难点)  ——>  按照这个目录爬取就完事儿

难点是生成对应的目录文件夹然后保存.md文件

<img src="%E7%88%AC%E5%8F%96%E8%AF%AD%E9%9B%80.assets/image-20231115165510405.png" alt="image-20231115165510405" style="zoom: 67%;" />

这段代码做的就是生成一个目录

```python
# BY @burpheart
# https://www.yuque.com/burpheart/phpaudit
# https://github.com/burpheart

import json
import os
import re
import urllib.parse

import requests

# 创建空列表
tset = []


# 保存
def save_page(sulg, book_id, path):
    '''
        定义了一个名为save_page的函数，它接受三个参数：book_id、sulg和path。
        这个函数使用requests库发送GET请求，下载指定URL的文档内容，并将其保存到指定的路径。
    '''
    docsdata = requests.get(
        'https://www.yuque.com/api/docs/' + sulg + '?book_id=' + book_id + '&merge_dynamic_data=false&mode=markdown')
    if (docsdata.status_code != 200):
        print("文档下载失败 页面可能被删除 ", book_id, sulg, docsdata.content)
        return
    docsjson = json.loads(docsdata.content)

    f = open(path, 'w', encoding='utf-8')
    f.write(docsjson['data']['sourcecode'])
    f.close()


def get_book(url="https://www.yuque.com/aceld/mo95lb/frv2c9"):
    docsdata = requests.get(url)
    """使用正则表达式模式decodeURIComponent\(\"(.+)\"\)\);来匹配满足以下条件的字符串：
        - 以decodeURIComponent("开头
        - 以");结尾
        - 中间包含一个或多个任意字符（使用(.+)表示）
    """
    data = re.findall(r"decodeURIComponent\(\"(.+)\"\)\);", docsdata.content.decode('utf-8'))

    docsjson = json.loads(urllib.parse.unquote(data[0]))  # 进行URL解码, 再将json转化成字典
    test = []
    dict = {}
    temp = {}  # 保存路径
    md = ""  # 保存路径
    """
    这行代码的作用是创建一个字符映射表（translation table），用于将字符串中的特定字符替换为指定的字符。

    具体来说，str.maketrans()函数接受两个参数，第一个参数是要被替换的字符，第二个参数是替换后的字符。在这行代码中，我们传递了两个字符串作为参数：

    - '\/:*?"<>|'：这是要被替换的字符集合，包括斜杠、反斜杠、冒号、星号、问号、双引号、小于号、大于号和竖线。
    - "___________"：这是替换后的字符，用下划线字符替换原始字符串中的特定字符。

    通过调用str.maketrans()函数，我们创建了一个字符映射表table，它将原始字符串中的特定字符映射为下划线字符。这个映射表可以在后续的代码中用于替换字符串中的特定字符。
            
    
    """
    table = str.maketrans('\/:*?"<>|' + "\n\r", "___________")  # windows操作系统中规定文件名中不能含有的符号是
    """
     '\/:*?"<>|'：这是要被替换的字符集合，包括斜杠、反斜杠、冒号、星号、问号、双引号、小于号、大于号和竖线。
     "___________"：这是替换后的字符，用下划线字符替换原始字符串中的特定字符。
    """
    prename = ""
    # 创建下载目录
    if (os.path.exists("download/" + str(docsjson['book']['id'])) == False):
        os.makedirs("download/" + str(docsjson['book']['id']))

    # 这段代码是用于生成目录结构的部分。它遍历docsjson['book']['toc']中的每个元素，并根据条件判断生成相应的目录项。
    for doc in docsjson['book']['toc']:
        # 文件夹
        if (doc['type'] == 'TITLE' or doc['child_uuid'] != ''):
            # 如果doc['type']等于'TITLE'或者doc['child_uuid']不为空
            filename = ''
            # 2. 将doc['title']和doc['parent_uuid']存储到dict[doc['uuid']]字典中，键为'0'和'1'。
            # 3. 将doc['uuid']作为键，初始化temp[doc['uuid']]为空字符串。
            dict[doc['uuid']] = {'0': doc['title'], '1': doc['parent_uuid']}  # 此dict非彼dict
            uuid = doc['uuid']  # 键及当前id
            temp[doc['uuid']] = ''  # 初始化temp[doc['uuid']]为空字符串  //文件夹路径
            while True:
                if (dict[uuid]['1'] != ''):
                    # 在循环中，如果dict[uuid]['1']不为空及doc['parent_uuid']，将执行以下操作
                    if temp[doc['uuid']] == '':
                        # 如果temp[doc['uuid']]为空，将doc['title']经过字符映射表table的替换后赋值给temp[doc['uuid']]。
                        temp[doc['uuid']] = doc['title'].translate(table)
                    else:
                        temp[doc['uuid']] = dict[uuid]['0'].translate(table) + '/' + temp[doc['uuid']]
                    uuid = dict[uuid]['1']  # 将dict[uuid]['1']及当前父id赋值给当前id，继续下一次循环
                else:
                    # doc['parent_uuid']为空表示是父目录
                    temp[doc['uuid']] = dict[uuid]['0'].translate(table) + '/' + temp[doc['uuid']]
                    break
            # 创建文件夹
            if ((os.path.exists("download/" + str(docsjson['book']['id']) + '/' + temp[doc['uuid']])) == False):
                os.makedirs("download/" + str(docsjson['book']['id']) + '/' + temp[doc['uuid']])

            # 创建目录  
            """
                如果temp[doc['uuid']]字符串以斜杠字符"/"结尾，表示当前目录项是一个文件夹。在Markdown格式中，使用##作为文件夹的标题，所以代码会将"## "和去除最后一个字符后的temp[doc['uuid']]字符串拼接起来，并添加到md字符串中。

                如果temp[doc['uuid']]字符串不以斜杠字符"/"结尾，表示当前目录项是一个文件。在Markdown格式中，使用*作为文件的列表项，所以代码会根据斜杠字符的数量来确定文件的缩进级别，然后将"* "和去除路径部分后的temp[doc['uuid']]字符串拼接起来，并添加到md字符串中。

                这段代码的作用是根据目录项的类型（文件夹或文件）和层级关系，生成相应的Markdown格式的目录项。
            """
            if (temp[doc['uuid']].endswith("/")):  # 是根文件夹
                """
                用于检查temp[doc['uuid']]字符串是否以斜杠字符"/"结尾。
                endswith()是字符串的一个方法，用于判断字符串是否以指定的后缀结尾，并返回布尔值。
                """
                md += "## " + temp[doc['uuid']][:-1] + "\n"
            else:  # 不是根文件夹, 通过\判断是几级的
                """
                具体来说，代码使用temp[doc['uuid']].count("/") - 1计算斜杠字符的数量减去1，
                然后使用" " * (temp[doc['uuid']].count("/") - 1)生成对应数量的空格作为缩进。
                接着，使用temp[doc['uuid']][temp[doc['uuid']].rfind("/") + 1:]获取
                最后一个斜杠字符后面的部分作为目录项的标题。最后，将缩进和标题拼接起来，并添加到md字符串中。
                """
                md += "  " * (temp[doc['uuid']].count("/") - 1) + "* " + temp[doc['uuid']][
                                                                         temp[doc['uuid']].rfind("/") + 1:] + "\n"
        # .md                                                                
        if (doc['url'] != ''):
            # 表示是一个md文件
            if doc['parent_uuid'] != "":
                if (temp[doc['parent_uuid']].endswith("/")):  # 以/结尾表示是根文件夹
                    md += " " * temp[doc['parent_uuid']].count("/") + "* [" + doc['title'] + "](" + urllib.parse.quote(
                        temp[doc['parent_uuid']] + "/" + doc['title'].translate(table) + '.md') + ")" + "\n"
                else:
                    md += "  " * temp[doc['parent_uuid']].count("/") + "* [" + doc['title'] + "](" + urllib.parse.quote(
                        temp[doc['parent_uuid']] + "/" + doc['title'].translate(table) + '.md') + ")" + "\n"  # 进行url 编码
                # 保存 传入 sulg 和 book_id
                save_page(doc['url'], str(docsjson['book']['id']),
                          "download/" + str(docsjson['book']['id']) + '/' + temp[doc['parent_uuid']] + "/" + doc[
                              'title'].translate(table) + '.md')
            else:
                md += " " + "* [" + doc['title'] + "](" + urllib.parse.quote(
                    doc['title'].translate(table) + '.md') + ")" + "\n"
                # 保存    
                save_page(doc['url'], str(docsjson['book']['id']),
                          "download/" + str(docsjson['book']['id']) + "/" + doc[
                              'title'].translate(table) + '.md')
    # 把上述得到的目录生成一个摘要                       
    f = open("download/" + str(docsjson['book']['id']) + '/' + "/SUMMARY.md", 'w', encoding='utf-8')
    f.write(md)
    f.close()


if __name__ == '__main__':
    # if len(sys.argv) > 1:
    #     get_book(sys.argv[1])
    # else:
    #     get_book()
    dict = ["https://www.yuque.com/xiaoyulive/frontend/echarts", "https://www.yuque.com/xiaoyulive/vscode",
            "https://www.yuque.com/xiaoyulive/uniapp/bfn5o2", "https://www.yuque.com/xiaoyulive/cicd/gr55wu",
            "https://www.yuque.com/xiaoyulive/kubernetes/xui5av", "https://www.yuque.com/xiaoyulive/docker/qlh70b",
            "https://www.yuque.com/xiaoyulive/flutter/twcg6y", "https://www.yuque.com/xiaoyulive/typescript/euxhdb"
        , "https://www.yuque.com/xiaoyulive/dart/lbk8fr", "https://www.yuque.com/xiaoyulive/flutter",
            "https://www.yuque.com/xiaoyulive/linux/uuhcbp#sed"]
    for url in dict:
        get_book(url)

```

![image-20231115233054291](%E7%88%AC%E5%8F%96%E8%AF%AD%E9%9B%80.assets/image-20231115233054291.png)



![image-20231116104218223](%E7%88%AC%E5%8F%96%E8%AF%AD%E9%9B%80.assets/image-20231116104218223.png)





```java
import json
import os
import re
import urllib.parse
import urllib.parse

import requests


def save_page(sulg, book_id, file_path):
    '''
    定义了一个名为save_page的函数，它接受三个参数：book_id、sulg和path。
    这个函数使用requests库发送GET请求，下载指定URL的文档内容，并将其保存到指定的路径。
    '''
    url = 'https://www.yuque.com/api/docs/' + sulg + '?book_id=' + book_id + '&merge_dynamic_data=false&mode=markdown'
    docsdata = requests.get(url)
    if (docsdata.status_code != 200):
        print("文档下载失败 页面可能被删除 ", book_id, sulg, docsdata.content)
        return

    docsjson = json.loads(docsdata.content)
    with open(file_path, 'w', encoding='utf-8') as f:
        f.write(docsjson['data']['sourcecode'])


# 将生成目录结构的逻辑封装在一个名为generate_directory_structure的函数
def generate_directory_structure(docsjson):
    md = ""
    dict = {}
    temp = {}  # 路径
    table = str.maketrans('\\/:*?"<>|', '_________')  # windows操作系统中规定文件名中不能含有的符号是, 出现了用_________替换

    def generate_md_link(title, url):
        return f"* [{title}]({urllib.parse.quote(url)})\n"

    def generate_md_folder(title):
        return f"## {title}\n"

    def generate_md_file(title, indent_level):
        return f"{'  ' * indent_level}* {title}\n"

    for doc in docsjson['book']['toc']:
        if doc['type'] == 'TITLE' or doc['child_uuid'] != '':
            filename = ''
            dict[doc['uuid']] = {'0': doc['title'], '1': doc['parent_uuid']}
            uuid = doc['uuid']
            temp[doc['uuid']] = ''
            while True:
                if dict[uuid]['1'] != '':
                    if temp[doc['uuid']] == '':
                        temp[doc['uuid']] = doc['title'].translate(table)
                    else:
                        temp[doc['uuid']] = dict[uuid]['0'].translate(table) + '/' + temp[doc['uuid']]
                    uuid = dict[uuid]['1']
                else:
                    temp[doc['uuid']] = dict[uuid]['0'].translate(table) + '/' + temp[doc['uuid']]
                    break

            folder_path = os.path.join("download", str(docsjson['book']['id']), temp[doc['uuid']])
            if not os.path.exists(folder_path):
                os.makedirs(folder_path)

            if doc['url'] != '':
                if doc['parent_uuid'] != '':
                    parent_folder_path = temp[doc['parent_uuid']]
                    if parent_folder_path.endswith("/"):
                        md += " " * parent_folder_path.count("/") + generate_md_link(doc['title'],
                                                                                     os.path.join(parent_folder_path,
                                                                                                  doc[
                                                                                                      'title'].translate(
                                                                                                      table) + '.md'))
                    else:
                        md += "  " * parent_folder_path.count("/") + generate_md_link(doc['title'],
                                                                                      os.path.join(parent_folder_path,
                                                                                                   doc[
                                                                                                       'title'].translate(
                                                                                                       table) + '.md'))
                    save_page(doc['url'], str(docsjson['book']['id']),
                              os.path.join(folder_path, doc['title'].translate(table) + '.md'))
                else:
                    md += " " + generate_md_link(doc['title'], doc['title'].translate(table) + '.md')
                    save_page(doc['url'], str(docsjson['book']['id']),
                              os.path.join(folder_path, doc['title'].translate(table) + '.md'))

    summary_file_path = os.path.join("download", str(docsjson['book']['id']), "SUMMARY.md")
    with open(summary_file_path, 'w', encoding='utf-8') as f:
        f.write(md)


def get_book(url="https://www.yuque.com/aceld/mo95lb/frv2c9"):
    docs_data = requests.get(url)
    """
    使用正则表达式模式decodeURIComponent\(\"(.+)\"\)\);来匹配满足以下条件的字符串：
        - 以decodeURIComponent("开头
        - 以");结尾
        - 中间包含一个或多个任意字符（使用(.+)表示）
    """
    data = re.findall(r"decodeURIComponent\(\"(.+)\"\)\);", docs_data.content.decode('utf-8'))
    docs_json = json.loads(urllib.parse.unquote(data[0]))  # 进行URL解码, 再将json转化成字典

    generate_directory_structure(docs_json)


if __name__ == '__main__':
    get_book('https://www.yuque.com/yuque/developer/api')
```

